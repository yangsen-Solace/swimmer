<!DOCTYPE html>
<html>

<head>
  <title>Solace Event Driven Airport Demo</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <link rel="shortcut icon" type="image/png" href="favicon.ico" />
  <link rel="stylesheet" href="alertify.js-0.3.11/themes/alertify.core.css" />
  <!-- include a theme, can be included into the core instead of 2 separate files -->
  <link rel="stylesheet" href="alertify.js-0.3.11/themes/alertify.default.css" />
  <style>
    html,
    body {
      height: 100%;
      margin: 0px;
      padding: 0px;
      overflow: hidden; /* Hide scrollbars */
    }

    #map-canvas {
      height: 100%;
      margin: 0px;
      padding: 0px;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2Lx4NftTlKl8d5mvekVgYf6nRzzusQHQ&v=beta&libraries=visualization"></script>
  <script type="text/javascript" src="solclient-full.js"></script>
  <script type="text/javascript" src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <!--script type="text/javascript" src="marker_with_label.js"></script-->
  <script type="text/javascript" src="qrcode.min.js"></script>
  <script src="alertify.js-0.3.11/lib/alertify.min.js"></script>
  <style>
    #wrapper {
      position: relative;
    }

    #topicMO {
      position:absolute;
      z-index: 10000000;
      /* background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid #999;
      font-family: 'sans-serif'; */
      background-color: rgba(51, 51, 51, 0.8);
      border: 1px solid #00c895;
      /* border: 1px solid #FF7F27; */
      font-family: 'sans-serif';
      padding: 7px 10px 5px 10px;
      /* line-height: 30px;
      padding-left: 10px; */
      top: 10px;
      left: 10px;
    }

    #real-time-topics {
      position: fixed;
      bottom: 10px;
      left: 50%;
      z-index: 101;
      margin-left: -450px; /* approx */
      background-color: rgba(51, 51, 51, 0.8);
      /* border: 1px solid #00c895; */
      border: 1px solid #00c895;
      /* border: 1px solid #FF7F27; */
      /* padding: 2px 8px 3px 8px; */
      padding: 10px;
      /* margin: auto; */
      /* margin-left: auto;
      margin-right: auto; */
      line-height: 30px;
    }

    #over_map_filtering {
      position: absolute;
      top: 10px;
      left: 10px;
      /* left: 100px; */
      z-index: 99;
      background-color: rgba(61, 61, 61, 0.8);
      padding: 10px;
      border: 1px solid #00c895;
      font-family: 'sans-serif';
      line-height: 30px;
      padding-left: 10px;
    }

    #over_map_tr {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 98;
      background-color: rgba(61, 61, 61, 0.8);
      padding: 10px;
      border: 1px solid #00c895;
      font-family: 'sans-serif';
      line-height: 30px;
      padding-left: 10px;
    }

    #over_map_busapp_qr {
      position: absolute;
      bottom: 24px;
      right: 60px;
      z-index: 97;
      background-color: rgba(61, 61, 61, 0.8);
      padding: 10px;
      border: 1px solid #00c895;
      /* border: 1px solid #FF7F27; */
      font-family: 'sans-serif';
      line-height: 30px;
      padding-left: 10px;
    }

    #over_map_bl {
      position: absolute;
      bottom: 32px;
      left: 10px;
      z-index: 98;
      background-color: rgba(61, 61, 61, 0.8);
      padding: 10px;
      border: 1px solid #00c895;
      font-family: 'sans-serif';
      line-height: 30px;
    }

    #over_map_fence {
      position: absolute;
      bottom: 24px;
      right: 235px;
      z-index: 95;
      background-color: rgba(61, 61, 61, 0.8);
      padding: 10px;
      border: 1px solid #00c895;
      /* border: 1px solid #FF7F27; */
      font-family: 'sans-serif';
      line-height: 30px;
      padding-left: 10px;
    }

    h1 {
      /*font: 18pt Roboto, sans-serif;*/
      font: 18pt Roboto, sans-serif;
      color: #ffffff;
      padding: 2px;
      margin-top: 0px;
      margin-bottom: 0px;
    }

    h2 {
      /*font: 14pt Roboto, sans-serif;*/
      font: 16pt Roboto, sans-serif;
      color: #ffffff;
      padding: 2px;
      margin-top: 0px;
      margin-bottom: 0px;
    }

    h3 {
      /*font: 12pt Roboto, sans-serif;*/
      font: 14pt Roboto, sans-serif;
      color: #ffffff;
      padding: 2px;
      margin-top: 0px;
      margin-bottom: 0px;
    }

    h4 {
      /*font: 12pt Roboto, sans-serif;*/
      font: 18pt Roboto, sans-serif;
      color: #ffffff;
      padding: 2px;
      margin-top: 0px;
      margin-bottom: 0px;
    }

    p, td, a {
      /*font: 9pt Roboto, sans-serif;*/
      font: 11pt Roboto, sans-serif;
      color: #ffffff;
      /* padding: 0px; */
      padding: 1px 0px;
      margin-top: 1px;
      margin-bottom: 1px;
    }

/*    a:hover {
       color: #f4961c;
    }*/

/*    .orange_o {
      color: #f4961c;
      font: 17pt century gothic;
    }
 
    .sliders {
      font: 16pt Haettenschweiler, Impact, fantasy;
      color: #003b74;
    }
 */


    .newSliders {
      /*font: 9pt Roboto, sans-serif;*/
      font: 11pt Roboto, sans-serif;
      color: #fff;
    }

    input[type=text], select {
      color: #ffffff;
      border: 2px solid #00c895;
      border-radius: 10px;
      background-color: rgba(61, 61, 61, 0.9);
    }

    button {
      color: #fff;
      border: 2px solid #00c895;
      border-radius: 12px;
      background-color: rgba(61, 61, 61, 0.9);
    }

    button:hover {
      background-color: #00c895;
      border: 2px solid rgba(61, 61, 61, 0.9);
      color: rgba(61, 61, 61, 0.9);
    }

    /* copied from aaron's sunburst diagram */
/* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
.slider::-webkit-slider-thumb {
  -webkit-appearance: none; /* Override default look */
  appearance: none;
  width: 11px; /* Set a specific slider handle width */
  height: 11px; /* Slider handle height */
  border-radius: 6px;
  background: #00c895; /* Green background */
  cursor: pointer; /* Cursor on hover */
  /* border: 2px solid rgba(0, 0, 0, 0.5); */
}



/* The slider itself */
.slider {
  -webkit-appearance: none;  /* Override default CSS styles */

  /*-webkit-appearance: none;*/  /* Override default CSS styles */
  /*appearance: none;*/
  width: 120px; /* Full-width */
  height: 3px; /* Specified height */
  background: #00c895;
  outline: none; /* Remove outline */
  opacity: 1; /* Set transparency (for mouse-over effects on hover) */
  -webkit-transition: .2s; /* 0.2 seconds transition on hover */
  transition: opacity .2s;
  /* padding-bottom: 5px; */
}


  </style>
  <script>
    // This example adds a user-editable rectangle to the map.

    var map;
    var heatmap;
    var searchShapes = { "poly": [], "circle": [], "rect": [] };  // used to be just poly and circle
    var totalSearchShapes = 0;
    var dragging = false;  // ignore the set_at events from the shapes when they're being dragged
    var poly;
    var circle;
    //var oldRequestStr = "ALL";
    var oldRequestObj = {};
    var boundary;
    var subs2;
    var subLabel;
    var accuracy = 0.9;
    var numSubs = 300;
    var curSubs = 1;
    var lastResults = "";
    var zoomLevel;
    var globalZindex = 100;
    var heatToggle = false;
    var MAX_TOPICS = 2010;

    var vehicles = {};  // loc,

    var directionsDisplay;
    var directionsService = new google.maps.DirectionsService();

    var iconImageRed = {
      url: "marker-blue_car-dark-red_bg-light-pink.png",
      anchor: {
        x: 21,
        y: 60
      }
    };
    var iconImage2 = {
      url: "marker-blue_car-black_bg-white.png",
      anchor: { x: 21, y: 60 }
    };
    var icon_dot = {
      url: "dot.png",
      anchor: { x: 7, y: 7 }
    };

    var icon_bus_small_ok = { url: "green_small_ok.png", anchor: { x: 4, y: 4 } };
    var icon_bus_small_stop = { url: "green_small_stop.png", anchor: { x: 4, y: 4 } };
    var icon_bus_small_msg = { url: "green_small_msg.png", anchor: { x: 4, y: 4 } };
    var icon_bus_small_fault = { url: "green_small_fault.png", anchor: { x: 4, y: 4 } };
    var icon_bus_med_ok = { url: "green_med_ok.png", anchor: { x: 8, y: 8 } };
    var icon_bus_med_stop = { url: "green_med_stop.png", anchor: { x: 8, y: 8 } };
    var icon_bus_med_msg = { url: "green_med_msg.png", anchor: { x: 8, y: 8 } };
    var icon_bus_med_fault = { url: "green_med_fault.png", anchor: { x: 8, y: 8 } };

    var icon_bus_white_arrow = { url: "gfx/marker-green-white-arrow.png", anchor: { x: 16, y: 16 } };

    var icon_buses = [];
    var icon_markers = [];
    for (var i=0;i<36;i++) {
      icon_buses.push({ url: "gfx/" + i.toString().padStart(4,'0') + ".png"});
      icon_markers.push({ url: "gfx/marker2_" + i.toString().padStart(4,'0') + ".png"});
    }


    // const subsColor = '#4488ff';
    // const shapeColor = '#4488ff';
    const subsColor = '#f71';
    const shapeColor = '#f71';
    // const subsColor = '#FF7F27';
    // const shapeColor = '#FF7F27';
    // const levelColors = [ '#aaa', '#5f5', '#f5f', '#0ff', '#ff0', '#58f', '#f55', '#fff', '#fa0', '#888' ];
    const levelColors = [ '#aaa', '#5f5', '#58f', '#ff0', '#f5f', '#f71', '#f71', '#0ff', '#fff', '#888' ];
    /*
            <span style="color:#fff">geo</span
          >/<span style="color:#5f5;">bus</span
          >/<span style="color:#f5f;">{busNum}}</span
          >/<span style="color:#05f;">{lat}</span
          >/<span style="color:#ff0;">{lon}</span
          >/<span style="color:#0ff;">{routeNum}</span
          >/<span style="color:#f55;">{status}</span>
*/
    function makeHtmlColors(topic) {
      // we're assuming that the span has color grey for / chars
      var levels = topic.split("/");
      var str = "";
      for (var i=0; i<levels.length; i++) {
        /*if (i >= 5 && i <= 6) {  // lat,lon
          //var geo = levels[i];
          if (levels[i].length <= 1) {
            str += "<span style=\"color: "+levelColors[i]+";\">" + levels[i] + "</span>";
          } else {
            str += "<span style=\"color: "+levelColors[i]+";\">" + levels[i].slice(0,levels[i].length-2) + "</span>";
            str += "<span style=\"color: #ff8d38;\">" + levels[i].slice(-1) + "</span>";
          }
        } else {*/
          str += "<span style=\"color: "+levelColors[i]+";\">" + levels[i] + "</span>";
        //}
        if (i < levels.length-1) str += "/";
      }
      if (levels.length < 7) str += "<span style=\"color: "+levelColors[0]+";\">&gt;</span>";
      return str;
    }



    function initialize() {
      var mapOptions = {
        center: new google.maps.LatLng(1.35661, 103.98788), // Singapore Changi Airport
        zoom: 16, // demo
		heading: 294,
        draggable: true,
        mapTypeId: 'hybrid',
		mapId: '975a1276b3c41f11',
        mapTypeControlOptions: {
          mapTypeIds: ['coordinate', 'roadmap'],
          style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
        },
        streetViewControl: false,
        scaleControl: true,
        drawable: true,
        clickable: false,
        // mapTypeControlOptions: {
          //mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
        // }
        styles: [
          {
            featureType: "all",
            elementType: "all",
            stylers: [
              {visibility: "on"},
              {lightness: 50},
              {gamma : 6},
              {invert_lightness: true}
            ]
          },
          {
            "featureType": "all",
            "elementType": "labels",
            "stylers": [
              {
                "visibility": "off"
              },
              {
                "saturation": "-100"
              }
            ]
          },
          {
            "featureType": "all",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "saturation": 36
              },
              {
                "color": "#000000"
              },
              {
                "lightness": 40
              },
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "all",
            "elementType": "labels.text.stroke",
            "stylers": [
              {
                "visibility": "off"
              },
              {
                "color": "#000000"
              },
              {
                "lightness": 16
              }
            ]
          },
          {
            "featureType": "all",
            "elementType": "labels.icon",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "administrative",
            "elementType": "geometry.fill",
            "stylers": [
              {
                "color": "#000000"
              },
              // {
              //   "lightness": 20
              // }
            ]
          },
          {
            "featureType": "administrative",
            "elementType": "geometry.stroke",
            "stylers": [
              {
                "color": "#0000ff"
              },
              // {
              //   "lightness": 17
              // },
              {
                "weight": 0.5
              }
            ]
          },
          {
            "featureType": "landscape",
            "elementType": "geometry",
            "stylers": [
              {
                "color": "#000000"
              },
              {
                "lightness": 100
              }
            ]
          },
          {
            "featureType": "landscape",
            "elementType": "geometry.fill",
            "stylers": [
              {
                // color: "#4d6059"
                color: "#333333"
              }
            ]
          },
          {
            "featureType": "landscape",
            "elementType": "geometry.stroke",
            "stylers": [
              {
                // "color": "#4d6059"
                "color": "#000000"
              }
            ]
          },
          {
            "featureType": "landscape.natural",
            "elementType": "geometry.fill",
            "stylers": [
              {
                // "color": "#4d6059"
                "color": "#333333"
              }
            ]
          },
          {
            "featureType": "poi",
            "elementType": "geometry",
            "stylers": [
              {
                // "lightness": 21
                "lightness": 100
              }
            ]
          },
          {
            "featureType": "poi",
            "elementType": "geometry.fill",
            "stylers": [
              {
                // "color": "#4d6059"
                "color": "#333333"
              }
            ]
          },
          {
            "featureType": "poi",
            "elementType": "geometry.stroke",
            "stylers": [
              {
                // "color": "#4d6059"
                "color": "#000000"
              }
            ]
          },
          {
            "featureType": "road",
            "elementType": "geometry",
            "stylers": [
              {
                "visibility": "on"
              },
              {
                // "color": "#7f8d89"
                "color": "#666666"
              }
            ]
          },
          {
            "featureType": "road",
            "elementType": "geometry.fill",
            "stylers": [
              {
                // "color": "#7f8d89"
                "color": "#666666"
              }
            ]
          },
          {
            "featureType": "road.highway",
            "elementType": "geometry.fill",
            "stylers": [
              {
                // "color": "#7f8d89"
                "color": "#6a6666"
              },
              // {
              //   "visibility": "off"
              // }
              // ,
              // {
              //   "lightness": 17
              // }
            ]
          },
          {
            "featureType": "road.highway",
            "elementType": "geometry.stroke",
            "stylers": [
              // {
              //   // "color": "#7f8d89"
              //   color: "#776666"
              // },
              {
                "visibility": "off"
              }
            ]
          },
          // {
          //   "featureType": "road.arterial",
          //   "elementType": "geometry",
          //   "stylers": [
          //     {
          //       "color": "#0000ff"
          //     },
          //     // {
          //     //   "lightness": 18
          //     // }
          //   ]
          // },
          {
            "featureType": "road.arterial",
            "elementType": "geometry.fill",
            "stylers": [
              {
                // "color": "#7f8d89"
                "color": "#555559"
              }
            ]
          },
          {
            "featureType": "road.arterial",
            "elementType": "geometry.stroke",
            "stylers": [
              // {
              //   // "color": "#7f8d89"
              //   "color": "#557777"
              // },
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "road.local",
            "elementType": "geometry",
            "stylers": [
              // {
              //   "color": "#000000"
              // },
              // {
              //   "lightness": 16
              // }
            ]
          },
          {
            "featureType": "road.local",
            "elementType": "geometry.fill",
            "stylers": [
              {
                // "color": "#7f8d89"
                color: "#444844"
              }
            ]
          },
          {
            "featureType": "road.local",
            "elementType": "geometry.stroke",
            "stylers": [
          //     {
                // "color": "#7f8d89"
              //   "color": "#446644"
              // },
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "transit",
            "elementType": "geometry",
            // airports and stuff
            "stylers": [
              {
                "color": "#444444"
              },
              // {
              //   "lightness": 19
              // }
            ]
          },
          {
            "featureType": "water",
            "elementType": "all",
            "stylers": [
              {
                // "color": "#2b3638"
                "color": "#20262a"
              },
              {
                "visibility": "on"
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [
              {
                // "color": "#2b3638"
                "color": "#20262a"
              },
              {
                "lightness": 17
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "geometry.fill",
            "stylers": [
              {
                // "color": "#24282b"
                "color": "#20262a"
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "geometry.stroke",
            "stylers": [
              {
                // "color": "#24282b"
                "color": "#20262a"
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "labels",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "labels.text",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "labels.text.fill",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "labels.text.stroke",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          },
          {
            "featureType": "water",
            "elementType": "labels.icon",
            "stylers": [
              {
                "visibility": "off"
              }
            ]
          }
]


      };
      // console.log(JSON.stringify(mapOptions.styles));
      // directionsDisplay = new google.maps.DirectionsRenderer();


      // mapOptions.heading = 70;
      map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
      //map.mapTypes.set('map_style', styledMap);
      // map.setMapTypeId('terrain');
      // map.setMapTypeId('hybrid');
      // map.setMapTypeId('satellite');
      // map.setOptions(mapOptions);

      //map.setMapTypeId('map_style');
      // directionsDisplay.setMap(map);


      // Construct a draggable red polygon

      boundary = [];
      for (var i = 0; i < 2; i++) { // there's two because there are two shapes... need to change
        boundary[i] = new google.maps.Polygon({
          map: map,
          strokeColor: '#0000FF',
          strokeOpacity: 0.8,
          strokeWeight: 1,
          fillColor: '#0000FF',
          fillOpacity: 0.05,
          map: map,
          zIndex: 10,
          clickable: true,
          draggable: false,
          editable: false,
        });
      }

      subs2 = [];
      // var color = '#0000ff';
      //var color = '#f37021';
      // var color = '#009193';
      // var factor = 2;
      for (var i = 0; i < MAX_TOPICS; i++) {
        subs2[i] = new google.maps.Rectangle({
          title: "Hello there " + i,
          strokeColor: subsColor,
          // strokeOpacity: 1.0 - (factor * 0.15),
          // strokeWeight: 1.2 - (factor * 0.2),
          strokeOpacity: 0.5,
          strokeWeight: 1,
          fillColor: subsColor,
          fillOpacity: 0.05,
          zIndex: 1000000, //factor,
          clickable: true,
        });
      }
      // this is for the coordinate label that hovers
      //subLabel = new MarkerWithLabel({
      //   position: new google.maps.LatLng(0, 0),
      //   draggable: false,
      //   raiseOnDrag: false,
      //   map: map,
      //   labelContent: "blah",
      //   labelAnchor: new google.maps.Point(30, 20),
      //   labelClass: "labels", // the CSS class for the label
      //   labelStyle: {
      //     opacity: 1.0
      //   },
      //   icon: "http://placehold.it/1x1",
      //   visible: false
      // });

      // https://maps.googleapis.com/maps/api/streetview?size=300x200&location=51.614260,-0.060660&heading=300&pitch=0&fov=100



      //////////////////////////////////////////////////////////


      zoomLevel = map.getZoom();
      google.maps.event.addListener(map, 'zoom_changed', function () {
        console.log("Zoom changed!!  from " + zoomLevel + " to " + map.getZoom());
        if (heatmap.getMap() && map.getZoom() < 13) heatmap.setMap(null);
/*        if (zoomLevel >= 13 && map.getZoom() <= 12 ||
          zoomLevel <= 12 && map.getZoom() >= 13) { // crossing a threshold
          for (key in vehicles) {
            var vehicle = vehicles[key];
            if (vehicle["type"] == "bus") {
              setBusIcon(key);
            }
          }
          console.log("done!");
        }*/
        zoomLevel = map.getZoom();
        if (zoomLevel < 17) map.setMapTypeId('roadmap');
        else map.setMapTypeId('satellite');

        for (key in vehicles) {
          if (!vehicles.hasOwnProperty(key)) continue;
          setBusIcon(key);
        }
      });

      // this kicks off the heatmap to auto-refresh every 5 seconds
      heatmap = new google.maps.visualization.HeatmapLayer({
        // radius: 0.005,
        radius: 0.004,
        dissipating: false,
      });
      setInterval(function () {
        var points = [];
        for (var key in vehicles) {
          if (vehicles[key]["marker"].getMap() != null) points.push(vehicles[key]["pos"]);
        }
        heatmap.setData(points);
      }, 5000);
    }
    /////////// END OF MAP INITIALIZE method ////////////////////////////////////////

    function getRandomPoint() {
      // 1.333691, 103.828080   -- central Singapore
      var rLat = (Math.random() * 0.05) + 1.28;
      var rLng = (Math.random() * 0.1) + 103.8;
      // console.log(map.getBounds());//.lat+ "   -   "+map.getCenter().lon);
      // var rLat = (Math.random() * 0.05) + map.getCenter().lat;
      // var rLng = (Math.random() * 0.1) + map.getCenter().lng;
      return new google.maps.LatLng(rLat, rLng);  // a random point, somewhere centralish
    }

    function getPointNearPoint(point) {
      // var angle = Math.random() * 2 * Math.PI;
      var angle = (Math.random() * Math.PI / 8) + (Math.PI / 16) * (Math.random() * 4);  // 45 deg arcs, in each of the 4 quadrants
      var dist = (Math.random() + 0.5) * 0.05;
      return new google.maps.LatLng(point.lat() + (Math.cos(angle) * dist), point.lng() + (Math.sin(angle) * dist));
    }

    function addNewPolyCoords(coords) {
      coords = [new google.maps.LatLng(1.301,103.801),new google.maps.LatLng(1.399,103.801),new google.maps.LatLng(1.399,103.899),new google.maps.LatLng(1.301,103.899)];
      var poly = new google.maps.Polygon({
        map: map,
        paths: coords,
        strokeColor: shapeColor,
        strokeOpacity: 0.7,
        strokeWeight: 3,
        fillColor: shapeColor,
        fillOpacity: 0,//0.025,
        visible: true,
        draggable: true,
        clickable: true,
        editable: true,
        geodesic: false,
        zIndex: 200000,
      });
      searchShapes["poly"].push(poly);
      totalSearchShapes++;
      google.maps.event.addListener(poly.getPath(), 'set_at', updateSearch);
      google.maps.event.addListener(poly.getPath(), 'insert_at', updateSearch);
      google.maps.event.addListener(poly.getPath(), 'remove_at', updateSearch);
      google.maps.event.addListener(poly, 'dragstart', startDrag);
      google.maps.event.addListener(poly, 'dragend', endDrag);
    }

    function addNewPoly() {
      var p1 = getRandomPoint();
      var p2 = getPointNearPoint(p1);
      var latDist = p1.lat() - p2.lat();
      var lngDist = p1.lng() - p2.lng();
      var mid = new google.maps.LatLng((p1.lat() + p2.lat()) / 2, (p1.lng() + p2.lng()) / 2);
      var p3 = new google.maps.LatLng(((p1.lat() + p2.lat()) / 2) + lngDist, ((p1.lng() + p2.lng()) / 2) - latDist);
      var coords = [p1, p3, p2];
      if (Math.random() < 0.5) coords.push(new google.maps.LatLng(((p1.lat() + p2.lat()) / 2) - lngDist, ((p1.lng() + p2.lng()) / 2) + latDist));  // triangle -> parallogram
      addNewPolyCoords(coords);
    }

    function startDrag() { console.log("DRAGGGIN!!!!"); dragging = true; document.getElementById("topicMO").style.display = "none"; }
    function endDrag() { console.log("NO MORE DRAGGGIN!!!!"); dragging = false; updateSearch(); }


    function addNewCircle() {
      var circle = new google.maps.Circle({
        map: map,
        center: getRandomPoint(),
        radius: 500 + (Math.random() * 2000),
        strokeColor: shapeColor,//'#FF0099',
        strokeOpacity: 0.7,
        fillColor: shapeColor,//'#FF0099',
        fillOpacity: 0.025,
        draggable: true,
        clickable: true,
        editable: true,
        visible: true,
        zIndex: 199999,
      });
      searchShapes["circle"].push(circle);
      totalSearchShapes++;
      google.maps.event.addListener(circle, 'radius_changed', updateSearch);
      google.maps.event.addListener(circle, 'center_changed', updateSearch);
      google.maps.event.addListener(circle, 'dragstart', startDrag);
      google.maps.event.addListener(circle, 'dragend', endDrag);
    }

    function addNewRect() {
      var p1 = getRandomPoint();
      var p2 = getPointNearPoint(p1);
      var rect = new google.maps.Rectangle({
        map: map,
        // bounds: new google.maps.LatLngBounds(p1,p2),
        bounds: {
          north: Math.max(p1.lat(), p2.lat()),
          south: Math.min(p1.lat(), p2.lat()),
          east: Math.max(p1.lng(), p2.lng()),
          west: Math.min(p1.lng(), p2.lng()),
        },
        strokeColor: shapeColor,//'#FF6600',
        strokeOpacity: 0.7,
        strokeWeight: 3,
        fillColor: shapeColor,//'#FF6600',
        fillOpacity: 0.025,
        visible: true,
        draggable: true,
        clickable: true,
        editable: true,
        zIndex: 199998,
      });
      searchShapes["rect"].push(rect);
      totalSearchShapes++;
      google.maps.event.addListener(rect, 'bounds_changed', updateSearch);
      google.maps.event.addListener(rect, 'dragstart', startDrag);
      google.maps.event.addListener(rect, 'dragend', endDrag);
    }

    function clearAllShapes() {
      for (key in searchShapes) {
        for (var i in searchShapes[key]) {
          searchShapes[key][i].setMap(null);
        }
      }
      searchShapes = { "poly": [], "circle": [], "rect": [] };
      totalSearchShapes = 0;
      updateSearch();
    }

    function getClass(obj) {
      if (obj instanceof google.maps.Rectangle) return "rect";
      else if (obj instanceof google.maps.Polygon) return "poly";
      else if (obj instanceof google.maps.Circle) return "circle";
      else return "Unknown";
    }

    function getColorForShape(what) {
      //http://bonsaiden.github.io/JavaScript-Garden/#types
      // Object.prototype.toString.call(obj).slice(8, -1);
      return shapeColor;
      if (what == "rect") return '#FF6600';
      else if (what == "circle") return '#FF0099';
      else if (what == "poly") return '#FF0000';
      else return '#000000';
    }

    function setWorking(busy) {
      if (busy) {
        for (key in searchShapes) {
          for (var i in searchShapes[key]) {
            searchShapes[key][i].setOptions({
              strokeColor: '#aaaaaa',
              editable: false,
              draggable: false,
            });
          }
        }
        // should disable the user inputs as well
        // document.querySelector('#display').disabled = true;
        // document.querySelector('#addRectButton').disabled = true;
        // document.querySelector('#addCirleButton').disabled = true;
        // document.querySelector('#fader').disabled = true;
        // document.querySelector('#fader2').disabled = true;
      } else {
        // for (var i in searchShapes) {
        //   searchShapes[i].setOptions({
        //     strokeColor: getColorForShape(searchShapes[i]),
        //     editable: true,
        //     draggable: true,
        //   });
        //   console.log( getColorForShape(searchShapes[i]));
        // }
        for (key in searchShapes) {
          for (var i in searchShapes[key]) {
            searchShapes[key][i].setOptions({
              strokeColor: getColorForShape(key),
              editable: true,
              draggable: true,
            });
          }
        }

        // document.querySelector('#display').disabled = false;
        // document.querySelector('#polyBox').disabled = false;
        // document.querySelector('#circleBox').disabled = false;
        // document.querySelector('#fader').disabled = false;
        // document.querySelector('#fader2').disabled = false;
      }
      //working = busy;
    }

    // called when something changes (shape boundary, slider value) to kick off a search
    function updateSearch() {
      document.getElementById("topicMO").style.display = "none";
      if (dragging) return;
      onPolyChange();
    }

    function getShapeCoords() {
      var searchObjects = {};
      var polys = [];
      var circles = [];
      for (key in searchShapes) {
        for (i in searchShapes[key]) {
          if (key == "poly") {
            polys.push(getPolyCoords(searchShapes[key][i]));
          } else if (key == "rect") {
            polys.push(getRectCoords(searchShapes[key][i]));
          } else {
            circles.push(getCircleCoords(searchShapes[key][i]));
          }
        }
      }
      if (polys.length != 0) searchObjects["polys"] = polys;
      if (circles.length != 0) searchObjects["circles"] = circles;
      return searchObjects;
    }


    function getRectCoords(rect) {
      var vertices = rect.getBounds();
      var ne = vertices.getNorthEast();
      var sw = vertices.getSouthWest();
      var coords = [];
      coords.push([ne.lat(), ne.lng()]);
      coords.push([ne.lat(), sw.lng()]);
      coords.push([sw.lat(), sw.lng()]);
      coords.push([sw.lat(), ne.lng()]);
      var rectObj = { "coords": coords };
      // console.log("This is what I send to the subscription manager: RECT='"+JSON.stringify(rectObj)+"'");
      return rectObj;
    }


    function getPolyCoords(poly) {
      var vertices = poly.getPath();
      var coords = [];
      for (var i = 0; i < vertices.getLength(); i++) {
        var xy = vertices.getAt(i);
        coords.push([xy.lat().toFixed(7) * 1, xy.lng().toFixed(7) * 1]);
      }
      var polyObj = { "coords": coords };
      // console.log("This is what I send to the subscription manager: POLY='"+JSON.stringify(polyObj)+"'");
      return polyObj;
    }

    function getCircleCoords(circle) {
      var xy = circle.getCenter();
      var circleObj = {};
      circleObj["coords"] = [xy.lat().toFixed(7) * 1, xy.lng().toFixed(7) * 1];
      // convert meters to lat/lon: https://stackoverflow.com/questions/8586635/convert-meters-to-latitude-longitude-from-any-point
      circleObj["radius"] = circle.getRadius().toFixed(1) * 1;
      circleObj["modifier"] = "metresToLatLon"
      // console.log("This is what I send to the subscription manager: CIRCLE='"+JSON.stringify(circleObj)+"'");
      return circleObj;
    }

    function makeSub(innerCoordStr, outerCoordStr, prePad) {
      var m = innerCoordStr.match(/^(-?)(\d+)\.?(\d*)$/);  // grab the sign, the left of decimal, and the right of decimal
      var m2 = outerCoordStr.match(/^(-?)(\d+)\.?(\d*)$/);
      var coordSub = m[1] ? "-" : "0";
      coordSub += m[2].padStart(prePad, "0");
      coordSub += ".";  // even in teh new version this doesn't hold true
      if (m[3]) coordSub += m[3];
      coordSub.padEnd(m2[3].length - m[3].length, "0");
      return coordSub;
    }

    function updateSubs(newSubCoords) {
      //subCoordsText = newSubCoords;
      var coords = newSubCoords.split("|");
      var numNewCoords = coords.length - 1;
      lastResults = coords[0];
      for (var i = 1; i <= numNewCoords; i++) {
        var pairs = coords[i].split(";");
        var innerLat = pairs[0].split(",")[0];
        var innerLon = pairs[0].split(",")[1];
        var outerLat = pairs[1].split(",")[0];
        var outerLon = pairs[1].split(",")[1]
        subs2[i].setBounds(new google.maps.LatLngBounds(
          new google.maps.LatLng(innerLat, innerLon),
          new google.maps.LatLng(outerLat, outerLon)));
          

        // new stuff for topic sub mouseover display
        // var m = innerLat.match(/^(-?)(\d+)\.?(\d*)$/);  // grab the sign, the left of decimal, and the right of decimal
        // var m2 = outerLat.match(/^(-?)(\d+)\.?(\d*)$/);
        // var topicLat = m[1] ? "-" : "0";
        // topicLat += m[2].padStart(2, "0");
        // topicLat += ".";  // even in teh new version this doesn't hold true
        // if (m[3]) topicLat += m[3];
        // topicLat.padEnd(m2[3].length - m[3].length, "0");
        var topicLat = makeSub(innerLat,outerLat,2);

        // var topicLon = innerLon;//.toFixed(5);
        // m = innerLon.match(/^(-?)(\d+)\.?(\d*)$/);
        // m2 = outerLon.match(/^(-?)(\d+)\.?(\d*)$/);
        // var topicLon = m[1] ? "-" : "0";
        // topicLon += m[2].padStart(3, "0");
        // topicLon += ".";  // even in teh new version this doesn't hold true
        // if (m[3]) topicLon += m[3];
        // topicLon.padEnd(m2[3].length - m[3].length, "0");
        var topicLon = makeSub(innerLon,outerLon,3);

        subs2[i]['_data_'] = oldRequestObj.topicPrefix + topicLat + "*/" + topicLon + "*/" + oldRequestObj.topicSuffix;// + "  (" + innerLat + "," + outerLat + "; " + (outerLat - innerLat);

        subs2[i].addListener("mouseover", function (event) {
          this.setOptions({ fillOpacity: 0.1, strokeOpacity: 1 });
          let topicSub = document.getElementById('topicMO');
          topicSub.innerHTML = makeHtmlColors(this._data_);
        });
        subs2[i].addListener("mousemove", function (event) {
          let circle = document.getElementById('topicMO');
          circle.style.left = (event.domEvent.x + 30) + 'px';
          circle.style.top = (event.domEvent.y + 20) + 'px';
          circle.style.display = "block";
        });
        google.maps.event.addListener(subs2[i], "mouseout", function () {
          this.setOptions({ fillOpacity: 0.05, strokeOpacity: 0.5 });
          let circle = document.getElementById('topicMO');
          circle.style.display = "none";
        });
        subs2[i].setMap(map);
        // google.maps.event.addListener(subs2[i], "mousemove", function(event) {
        //   var lat = event.latLng.lat();
        //   var lon = event.latLng.lng();
        //   var roundLat;
        //   if (lat > 0) roundLat = Math.floor(lat * 10000) / 10000;
        //   else roundLat = Math.ceil(lat * 10000) / 10000;
        //   var roundLon;
        //   if (lon > 0) roundLon = Math.floor(lon * 10000) / 10000;
        //   else roundLon = Math.ceil(lon * 10000) / 10000;
        //   subLabel.set("labelContent", "" + roundLat.toFixed(4) + ", " + roundLon.toFixed(4));
        //   subLabel.setPosition(event.latLng);
        //   subLabel.setVisible(true);
        // });
        // google.maps.event.addListener(subs2[i], "mouseout", function(event) {
        //   subLabel.setVisible(false);
        // });
      }
      setWorking(false); // done
      console.log("lastResults: " + lastResults);
      try {
        var match = lastResults.match("Num Subs = (\\d+), Coverage Ratio = ([0-9.]+)%");
        if (match[1] == 1) {
          console.log(numNewCoords);
          console.log(coords[1]);
          var c2 = coords[1].split(";");
          var c2i = c2[0].split(",");
          var c2o = c2[1].split(",");
          // console(c2);
          document.getElementById("sub").innerHTML = makeHtmlColors(oldRequestObj.topicPrefix + makeSub(c2i[0],c2o[0],2) + "*/" + makeSub(c2i[1],c2o[1],3) + "*/" + oldRequestObj.topicSuffix);
        }
        // if we're getting a response, that means that it can't be blank
        curSubs = match[1];
        document.getElementById('curSubs').innerHTML = "<span style=\"color:#f71;\">" + match[1] + "</span>";
        document.getElementById('curAccuracy').innerHTML = match[2] + "%";
      } catch (e) {
        console.log(e);
      }
    }

    // this is for the outline
    function updateSubsBoundary(newSubCoords) {
      //subCoordsText = newSubCoords;
      var coords = newSubCoords.split("|");
      lastResults = coords[0];
      for (var i = 1; i < coords.length; i++) {
        var pairs = coords[i].split(";");
        var boundaryCoords = [];
        for (var j = 0; j < pairs.length; j++) {
          var latlon = pairs[j].split(",");
          boundaryCoords.push(new google.maps.LatLng(latlon[0], latlon[1]));
        }
        boundary[i - 1].setPath(boundaryCoords);
        boundary[i - 1].setMap(map);
        // google.maps.event.addListener(boundary[i - 1], "mousemove", function(event) {
        //   var lat = event.latLng.lat();
        //   var lon = event.latLng.lng();
        //   var roundLat;
        //   if (lat > 0) roundLat = Math.floor(lat * 10000) / 10000;
        //   else roundLat = Math.ceil(lat * 10000) / 10000;
        //   var roundLon;
        //   if (lon > 0) roundLon = Math.floor(lon * 10000) / 10000;
        //   else roundLon = Math.ceil(lon * 10000) / 10000;
        //   subLabel.set("labelContent", "" + roundLat.toFixed(4) + ", " + roundLon.toFixed(4));
        //   subLabel.setPosition(event.latLng);
        //   subLabel.setVisible(true);
        // });
        // google.maps.event.addListener(boundary[i - 1], "mouseout", function(event) {
        //   subLabel.setVisible(false);
        // });
      }
      setWorking(false);
      console.log(lastResults);
    }



    google.maps.event.addDomListener(window, 'load', initialize);




    // solace code //////////////////////////////////////////////////////////////////////////////

    var OPERATION_TIMEOUT = 30000;
    var REQUEST_TIMEOUT = 10000;
    var ns = this;
    /**
     * Data members in the global scope
     */
    var mySessionProperties = null;
    var mySession = null;
    var myNickName = "AAron is awesome";
    var requestTopic = 'request/geo_filter';
    var connected = false;
    var working = false;
    var fenceUid = "" + (Math.random() + 1).toString(36).substring(2, 6);  // generate a "random" [0-9a-z] 4 char ID
    console.log("Fence UID: " + fenceUid);

    var sessionEventCb; // forward declaration
    var messageEventCb; // forward declaration

    var replyReceivedCb; // forward declaration
    var replyFailedCb; // forward declaration

    /**
     * Creates a message to with queryType as message's binary attachment
     * @param queryType
     * @return {solace.Message} message
     */
    this.createRequestMsg = function (polyCoordStr) {
      var msg = solace.SolclientFactory.createMessage();
      // Set the topic to requestTopic
      msg.setDestination(solace.SolclientFactory.createTopic(requestTopic));
      // Set delivery mode
      msg.setDeliveryMode(solace.MessageDeliveryModeType.DIRECT);
      // Set binary attachment
      msg.setBinaryAttachment(polyCoordStr);
      return msg;
    };

/*

    function onLogin() {
      var client2;
      client2 = mqtt.connect('wss://aaron.messaging.solace.cloud:8443', { username: 'bussub', password: 'bussub' });
      client2.on('connect', function () {
        console.log("CONNECTED via MQTT.js");
        client2.subscribe("$SYS/client/client-name", function (err) {
          if (!err) {
            // great, we can listen for requests..!
          } else {
            console.log(err);
          }
        });
          // listen to connect logs
          //client2.subscribe('$SYS/LOG/INFO/CLIENT/sgdemo1/CLIENT_CLIENT_CONNECT_MQTT/#');
      });

      client2.on('error', function(err) {
        console.log(new Date() + " ERRROROROROROOR");
        console.log(err);
      });


      client2.on('reconnect', function(err) {
        // Emitted when a reconnect starts.
        console.log(new Date() + " ERRROROROROROOR reconnect");
        console.log(err);
      });

      client2.on('message', function (topic, payload, packet) {
        // console.log("message rec: TOPIC:'"+topic+"', MSG:"+payload.toString())
        // totMsgs++;
        // msgRate++;
        console.log(topic);
        console.log(payload.toString());
        // addMessage(topic, packet.length);
        //console.log(packet);
      });
    }
*/


    /**
     * Invoked when the Ok button is clicked on the login dialog. This method will trigger the creation and connect()
     * operation on the session. When successfully connected, handle_sessionConnected() is invoked
     */
    this.onLogin = function () {
      // log to console
      //        var msg = "Creating Session: [ url='" + ns.utils_getUrl() + "', " +
      //                "user='" + ns.utils_getUserName() + ", vpn='" + ns.utils_getVPN() + "']";
      //      console.log(msg);
      // create the session
      try {
        // Create Session
        mySessionProperties = new solace.SessionProperties();
        mySessionProperties.connectTimeoutInMsecs = OPERATION_TIMEOUT;
        mySessionProperties.readTimeoutInMsecs = OPERATION_TIMEOUT;
        mySessionProperties.keepAliveIntervalsLimit = 10;
        //mySessionProperties.userName = "geoclient";
        mySessionProperties.userName = "solace-test";
        //mySessionProperties.password = "password";
        mySessionProperties.password = "123456";
        mySessionProperties.vpnName = "cag-demo";
        //mySessionProperties.vpnName = "geo-routing-demo";
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        //mySessionProperties.url = "http://192.168.56.101";
        //        mySessionProperties.url = "http://54.255.230.239";
        //mySessionProperties.url = "http://sgdemo1.solace.com";
        //mySessionProperties.url = "ws://mr-cfitsqc51.messaging.datago.io:20227";
        mySessionProperties.url = "wss://mr5438di0klhl.messaging.solace.cloud:443";  // aron's new SC service

        mySessionProperties.includeSenderId = true;
        //            myNickName = mySessionProperties.clientName = ns.utils_getNickName();

        mySession = solace.SolclientFactory.createSession(mySessionProperties,
          new solace.MessageRxCBInfo(function (session, message) {
            messageEventCb(session, message);
          }, this),
          new solace.SessionEventCBInfo(function (session, event) {
            sessionEventCb(session, event);
          }, this));
        console.log("Session was successfully created.");
        // Connect it
        mySession.connect();
        // start a background process to slowly facde out icons
        setInterval(function () {
          const dateNow = Date.now();
          var markedForDeletion = [];
          for (var key in vehicles) {
            var delta = dateNow - vehicles[key]["ts"];
            if (delta > 11000) {
              vehicles[key]["marker"].setMap(null);
              // now we need to delete it
              //vehicles[key] = null;
              //delete vehicles[key];
              markedForDeletion.push(key);
            } else if (delta > 9000) {
              vehicles[key]["marker"].setOpacity(0.33);
            } else if (delta > 6000) {
              vehicles[key]["marker"].setOpacity(0.66);
            }
          }
          for (var i of markedForDeletion) {
            // console.log("<<< BUS EXIT:  "+i);
            if (connected) {
              var message = solace.SolclientFactory.createMessage();
              var topicName = "geo/fence/" + fenceUid + "/exit/" + vehicles[i].payload.routeNum.padStart(4, '0') + "/" + (""+i).padStart(5,'0');
              message.setDestination(solace.SolclientFactory.createTopic(topicName));
              var newPayload = JSON.parse(JSON.stringify(vehicles[i].payload));
              newPayload['fenceStatus'] = "exit";
              newPayload['fenceUid'] = fenceUid;
              message.setBinaryAttachment(JSON.stringify(newPayload));
              message.setDeliveryMode(solace.MessageDeliveryModeType.DIRECT);
              // console.log('Publishing message "' + JSON.stringify(payload) + '" to topic "' + topicName + '"...');
              try {
                mySession.send(message);
                // console.log('Message published.');
              } catch (e) {
                console.error(e.toString());
              }
            }
            delete vehicles[i];
          }
        }, 500);

      } catch (error) {
        console.log("Could not login!");
        console.log(error.toString());
        if (mySession !== null) {
          mySession.dispose();
          mySession = null;
          connected = false;
        }
      }
      lastMsgCount = 0;
      discardCount = 0;
      //setTimeout(function(){ alert("Click 'Remove all shapes' to start the bus demo."); },3000);

      // setTimeout(clearAllShapes, 3000);
      setTimeout(function() {
        addNewPolyCoords([new google.maps.LatLng(1.301,103.801),new google.maps.LatLng(1.399,103.801),new google.maps.LatLng(1.399,103.899),new google.maps.LatLng(1.301,103.899)]);
        updateSearch();
      }, 3000);

      setInterval(function () {
        if (!connected) return;
        var curMsgs = mySession.getStat(solace.StatType.RX_TOTAL_DATA_MSGS);
        var delta = (curMsgs - lastMsgCount);// * 2 + (lastMsgCount % 2);
        lastMsgCount = curMsgs;
        discardCount = mySession.getStat(solace.StatType.RX_DISCARD_MSG_INDICATION);
        //console.log("Message rate: "+delta+",  Discard count: "+discardCount);
        //document.getElementById('rate').innerHTML = '<i><u>another</u></i>';
        document.getElementById('rate').innerHTML = '' + delta;
        // also show how many buses we're currently tracking
        document.getElementById('totalBuses').innerHTML = '' + Object.keys(vehicles).length;
      }, 1000);  // once a second
    };

    function getGeoSearchParams() {
      var params = {};
      params["accuracy"] = accuracy;
      params["numSubs"] = numSubs;
      //var show = document.querySelector('#show').value;  // buses or taxis or both
      var vehNum = document.querySelector('#vehNum').value;
      var routeNum = document.querySelector('#routeNum').value;
      var statusFilter = document.querySelector('#status').value;
      var prefix = "bus_trak/gps/v2/";
      var suffix = "";
      // route num
      if (routeNum == "") prefix += "*/";
      else if (routeNum.endsWith("*")) prefix += routeNum + "/";
      else {
        var numericPart = routeNum.replace(/\D/g,'');
        var alphaPart = routeNum.replace(/[^a-zA-Z]/g,'').toUpperCase();
        console.log(numericPart);
        console.log(alphaPart);
        // if (numericPart < 100) prefix += "0";
        // if (numericPart < 10) prefix += "0";

        prefix += numericPart.padStart(3,'0') + alphaPart + "*/";
      }
      // bus num
      if (vehNum == "") prefix += "*/";
      else prefix += vehNum.padStart(5,'0') + "/";

      // direction NE=0, NW=3
      suffix += document.querySelector('#heading').value + "/";  // b/c we now have direction
      if (statusFilter == "any") suffix += ">";
      else suffix += statusFilter;

      params["topicPrefix"] = prefix;
      params["topicSuffix"] = suffix;
      console.log(prefix + "  -  " + suffix);
      return params;
      // var paramStr = "accuracy=" + accuracy + ";";
      // paramStr += "numSubs=" + numSubs + ";";
      // // don't worry about this anymore... return both
      // paramStr += "display=" + document.querySelector('#display').value + ";";
      // return paramStr;
    }

    this.onPolyChange = function () {
      if (!connected) return;
      if (working) return;
      setWorking(true);
      for (var i = 0; i < MAX_TOPICS; i++) {
        subs2[i].setMap(null);
      }
      // currently, the subscription manager expects two sets of search requests, separated by |
      // the first is the new search, the 2nd is the previous one (so that it can undo/remove subscriptions for that)
      try {
        var requestObj = {};
        requestObj["shapes"] = getShapeCoords();
        Object.assign(requestObj, getGeoSearchParams());
        if (JSON.stringify(requestObj) == JSON.stringify(oldRequestObj)) {
          console.log("exact same search, not doing anything");
          setWorking(false);
          return;
        }
        if (totalSearchShapes > 0) document.getElementById("over_map_fence").style.display = "block";
        else document.getElementById("over_map_fence").style.display = "none";
        for (var i = 0; i < 2; i++) {
          boundary[i].setMap(null);
        }
        var prevRequestObj = oldRequestObj; // take a copy of what was asked for previously
        oldRequestObj = requestObj; // copy the new request for the record
        var newRequestObj = {}
        Object.assign(newRequestObj, requestObj);
        newRequestObj["previous"] = prevRequestObj;
        console.log("Request string: " + JSON.stringify(newRequestObj));
        // new stuff, for updating subscription 
        console.log(requestObj);
        if (requestObj.shapes.polys || requestObj.shapes.circles) {
          console.log("shapes");
          document.getElementById("sub").innerHTML = makeHtmlColors(requestObj.topicPrefix + "{lat}/{lon}/" + requestObj.topicSuffix);
        } else {
          console.log("no shapes");
          document.getElementById("sub").innerHTML = makeHtmlColors(requestObj.topicPrefix + "*/*/" + requestObj.topicSuffix);
        }

        var msg = createRequestMsg(JSON.stringify(newRequestObj));
        mySession.sendRequest(msg, REQUEST_TIMEOUT, function (session, message) {
          replyReceivedCb(session, message);
        }, function (session, event) {
          replyFailedCb(session, event);
        }, null);
        // if (oldRequestStr == "ALL") { // don't wait for a response from the sub mgr
        //   setWorking(false);
        // }
      } catch (error) {
        console.log("Failed to send polygon subscription request - logging out!");
        console.log(error.toString());
        if (mySession !== null) {
          mySession.dispose();
          mySession = null;
          connected = false;
        }
      }
    };

    /**
     * The session was successfully connected, the next step is to add the 'rendez-vous' topic subscription
     */
    this.handle_sessionConnected = function () {
      connected = true;
      //        onPolyChange();
      try {
        mySession.subscribe(solace.SolclientFactory.createTopic("cag/sin/flights/v1/gateChgWDelay/>"), false, this, OPERATION_TIMEOUT);
        mySession.subscribe(solace.SolclientFactory.createTopic("cag/sin/flights/v1/pkgStdChg/>"), false, this, OPERATION_TIMEOUT);
        mySession.subscribe(solace.SolclientFactory.createTopic("cag/sin/flights/v1/gateChg/>"), true, this, OPERATION_TIMEOUT);
		mySession.subscribe(solace.SolclientFactory.createTopic("cag/sin/flights/v1/pkgStdNRdy/>"), true, this, OPERATION_TIMEOUT);
		mySession.subscribe(solace.SolclientFactory.createTopic("cag/sin/flights/v1/paxLoadAlert/>"), true, this, OPERATION_TIMEOUT);
        // add my QR code for fence
        var opts = {
          errorCorrectionLevel: 'L',
          type: 'image/png',
          margin: 1,
          scale: 20,
          color: {
            dark: "#000000",
            light: "#ffffff",
          },
        };
        // console.log('Generating QR for: sg.solace.com/fence?' + fenceUid);
        QRCode.toDataURL('https://sg.solace.com/fence?' + fenceUid, opts, function (err, url) {
          document.getElementById("fence-qr").innerHTML = '<img width="60" src="' + url + '"/>';
          document.getElementById("fence-target").href = 'https://sg.solace.com/fence?' + fenceUid;
          // console.log(document.getElementById("fence-target"));
        });

      } catch (error) {
        console.log("Failed to add topic subscription. Disconnecting!");
        console.log(error.toString());
        if (mySession !== null) {
          mySession.dispose();
          mySession = null;
        }
        connected = false;
      }
    };

    /**
     * The subscription was successfully added, the next step is to send a 'I am logged in' message
     */
    this.handle_subscriptionOperationSucceeded = function () {
      console.log("subscription added");
    };

    /**
     * General failure
     * @param text
     * @param updateContent
     */
    this.handle_failure = function (text, updateContent) {
      console.log(text);
      connected = false;
      //        ns.cleanup();
    };

    /**
     * General cleanup
     */
    this.cleanup = function () {
      if (mySession !== null) {
        mySession.dispose();
        mySession = null;
        connected = false;
      }
    };

    ////////////////////// Callback functions //////////////////////////////////////////////////////////////////////////////

    /**
     * Session event callback
     * @param session
     * @param event
     */
    sessionEventCb = function (session, event) {
      console.log(event.toString());
      if (event.sessionEventCode === solace.SessionEventCode.UP_NOTICE) {
        ns.handle_sessionConnected();
      } else if (event.sessionEventCode === solace.SessionEventCode.SUBSCRIPTION_OK) {
        ns.handle_subscriptionOperationSucceeded();
      } else if (event.sessionEventCode === solace.SessionEventCode.SUBSCRIPTION_ERROR) {
        ns.handle_failure("Failed to add subscription", true);
      } else if (event.sessionEventCode === solace.SessionEventCode.LOGIN_FAILURE) {
        ns.handle_failure("Failed to login to appliance:" + event.infoStr, true);
      } else if (event.sessionEventCode === solace.SessionEventCode.CONNECTING) {
        console.log("Connecting...");
      } else if (event.sessionEventCode === solace.SessionEventCode.DISCONNECTED) {
        ns.handle_failure("Session is disconnected", false);
      } else {
        ns.handle_failure("Session failure!", false);
      }
    };

    /**
     * Direct message receive callback
     * @param session
     * @param message
     */


    messageEventCb = function (session, message) {
      try {
        var topic = message.getDestination().getName();
		if (topic.indexOf("track") != -1) {
          parseTrackMessage(message);
        } else if (topic.indexOf("pkgStdChg") != -1) {
          parsePkgStdChgMessage(message);
        } else if (topic.indexOf("gateChgWDelay") != -1) {
          parseGateChgWDelayMessage(message);
        } else if (topic.indexOf("gateChg") != -1) {
          parseGateChgMessage(message);
        } else if (topic.indexOf("pkgStdNRdy") != -1) {
          parsePkgStdNRdyMessage(message);
        } else if (topic.indexOf("paxLoadAlert") != -1) {
          parsePaxLoadAlertMessage(message);
        } else {
          console.log("Received unkonwn message on topic: " + topic);
        }
      } catch (e) {
        console.log(message);
        console.log(e);
        throw e;
      }

    }

    getTextPayload = function (message) {
      if (message.getType() == solace.MessageType.TEXT) {
        return message.getSdtContainer().getValue();
      } else {
        return message.getBinaryAttachment(); // binary attachment, all text
      }
    }

    parsePkgStdChgMessage = function(message) {
      var payload = JSON.parse(getTextPayload(message));
	  var notification = payload.flightno + " parking stand changed from " + payload.previous_parkingstand + " to " + payload.current_parkingstand;
	  alertify.log(notification, "", 0);
    }
	
	parseGateChgMessage = function(message) {
      var payload = JSON.parse(getTextPayload(message));
	  var notification = payload.flightno + " gate changed from " + payload.previous_gate + " to " + payload.current_gate;
	  alertify.log(notification, "", 0);
    }
	
	parseGateChgWDelayMessage = function(message) {
      var payload = JSON.parse(getTextPayload(message));
	  var notification = payload.flightno + " delayed to " + payload.estimated_time + " with gate changed from " + payload.previous_gate + " to " + payload.current_gate;
	  alertify.log(notification, "", 0);
    }
	
	parsePkgStdNRdyMessage = function(message) {
      var payload = JSON.parse(getTextPayload(message));
	  var notification = "Parking stand " + payload.current_parkingstand + " for flight " + payload.flightno + " is not active ";
	  alertify.log(notification, "", 0);
    }
	
	parsePaxLoadAlertMessage = function(message) {
      var payload = JSON.parse(getTextPayload(message));
	  var notification = payload.flightno + " gate changed from " + payload.previous_gate + " to " + payload.current_gate + " has more than 50 transit passengers";
	  alertify.log(notification, "", 0);
    }

    parseCommsMessage = function (message) {
      var levels = message.getDestination().getName().split("/"); // topic levels   geo/bus/1001/001.308820/0103.876270/007/OK  --> geo/bus/VehNum/lat/lon/Route/Status
      // comms/bus/1234
      // comms/route/012
      // comms/broadcast
      // comms/dispatch
      if (levels[2] == "bus") {
        var vehicle = vehicles[levels[3]];
        if (vehicle == null) {
          alert("No vehicle " + levels[3] + " present.");
          return;
        }
        var messageWindow = new google.maps.InfoWindow();
        messageWindow.setContent('<h3 style=\"color:#333;\"><b>' + message.getBinaryAttachment() + '</b></h3>');
        messageWindow.open(map, vehicle["marker"]);
        google.maps.event.addListener(messageWindow, 'closeclick', function () {
          vehicle["marker"].setAnimation(google.maps.Animation.NONE);
        });
        vehicle["marker"].setIcon(icon_bus_med_msg);
        vehicle["marker"].setAnimation(google.maps.Animation.BOUNCE);
        //vehicle["marker"].setZIndex(globalZindex + 100);  // pop to top
      } else if (levels[2] == "route") {
        for (var i = 1000; i < 10000; i++) { //var key in vehicles) {
          if (vehicles[i] != null && vehicles[i].payload.route == levels[3]) {
            vehicles[i]["marker"].setIcon(icon_bus_med_msg);
            // vehicles[i]["marker"].setZIndex(globalZindex++);  // pop to top
            vehicles[i]["marker"].setAnimation(google.maps.Animation.BOUNCE);
          }
        }
      } else if (levels[2] == "broadcast") {
        for (var i = 1000; i < 10000; i++) { //var key in vehicles) {
          if (vehicles[i] != null) {
            vehicles[i]["marker"].setIcon(icon_bus_med_msg);
            // vehicles[i]["marker"].setZIndex(globalZindex++);  // pop to top
            vehicles[i]["marker"].setAnimation(google.maps.Animation.BOUNCE);
          }
        }
      } else if (levels[2] == "dispatch") {
        console.log(message.payload);
        alert(getTextPayload(message));
      }
    }

    function buildBusInfoWindowContent(vehNum, topic) {
      var contentString = '<div id="content">';
      if (vehNum >= 1000 && vehNum < 10000) {   // bus
        var bus = vehicles[vehNum];
        contentString = '<h2 id="firstHeading" class="firstHeading" style="color:#333;">Route ' + bus.payload.routeNum + '</h2>';
        //contentString += '<p style="color:#333;">';
        contentString += '<h3 style="color:#333;">Topic:</h3><p style="background-color: #333; color:#aaa;"><b><code>' + makeHtmlColors(topic) + '</code></b></p>';
        contentString += '<h3 style="color:#333;">Payload:</h3><p><pre>' + JSON.stringify(bus.payload,null,4) + "</pre></p>";
//        contentString += '<b>Bus Number:</b> ' + vehNum + '<br/>';
//        contentString += '<b>Current Position:</b> ' + bus["marker"].getPosition().lat().toFixed(4) + 'N,' + bus["marker"].getPosition().lng().toFixed(4) + 'E<br/>';
//        contentString += '<b>Status:</b> ' + bus["payload"].status + '<br/>';
//        contentString += '<b>Speed:</b> ' + bus["payload"].speed + '<br/>';
//        contentString += '<b>Heading:</b> ' + bus["payload"].heading + '</p>';
//        contentString += '<br/><p style="color:#333;"><b>Topic:</b><br/><span style="background-color: #333; color:#aaa;"<b><code>' + makeHtmlColors(topic) + '</code></b></span></p>';
        // if (img != null) {
        //   contentString += '<p align="center"><img src="' + img + '"></p>';
        // }
        contentString += '</div>';
        return contentString;
      }

    }

    var sizes = [];
    // markers
    sizes[11] = new google.maps.Size(16,16);
    sizes[12] = new google.maps.Size(20,20);
    sizes[13] = new google.maps.Size(24,24);
    sizes[14] = new google.maps.Size(28,28);
    // buses
    sizes[15] = new google.maps.Size(48,48);
    sizes[16] = new google.maps.Size(64,64);
    sizes[17] = new google.maps.Size(80,80);
    sizes[18] = new google.maps.Size(100,100);
    sizes[19] = new google.maps.Size(128,128);
    sizes[20] = new google.maps.Size(128,128);

    function setBusIcon(vehNum) {
      var status = vehicles[vehNum]["payload"].status;
      //var marker = vehicles[vehNum]["marker"];
      //marker.setIcon(icon_buses[0]);
      // console.log(vehicles[vehNum]);
      var bus = vehicles[vehNum];
      var headingIndex = Math.floor((bus.payload.heading +5) / 10) % 36;
      if (zoomLevel <= 14) {  // marker
        bus.marker.setIcon(icon_markers[headingIndex]);
        // temporary:
        if (bus.payload.status.indexOf("FAULT") == 0) bus.marker.setIcon(icon_bus_med_fault);
        if (zoomLevel < 11) {
          bus.marker.getIcon().scaledSize = new google.maps.Size(12,12);
          bus.marker.getIcon().anchor = { x: 6, y: 6 };
        } else {  // it's in 11..15
          var anchorPoint = sizes[zoomLevel].width / 2;
          bus.marker.getIcon().scaledSize = sizes[zoomLevel];
          bus.marker.getIcon().anchor = { x: anchorPoint, y: anchorPoint };
        }
      } else {  // buses
        bus.marker.setIcon(icon_buses[headingIndex]);
        // temporary:
        if (bus.payload.status.indexOf("FAULT") == 0) bus.marker.setIcon(icon_bus_med_fault);
        if (zoomLevel > 20) {
          bus.marker.getIcon().scaledSize = new google.maps.Size(128,128);
          bus.marker.getIcon().anchor = { x: 64, y: 64 };
        } else {  // it's in 16..20
          var anchorPoint = sizes[zoomLevel].width / 2;
          bus.marker.getIcon().scaledSize = sizes[zoomLevel];
          bus.marker.getIcon().anchor = { x: anchorPoint, y: anchorPoint };
        }
      }
    }

    parseGeoMessage = function (message) {
try {
      var levels = message.getDestination().getName().split("/"); // topic levels
      var payload = JSON.parse(getTextPayload(message));
      // bad, don't rely on topics
      // var vehType = levels[0];
      // var vehNum = +levels[6];// * 1;
      // var lat = +levels[3];// * 1;
      // var lon = +levels[4];// * 1;
      var vehType = "bus";
      var vehNum = payload.busNum;
      var lat = payload.latitude;
      var lon = payload.longitude;
      var newOneEnteringShape = false;
      var vehicle;  // for later
      // now, have we seen this guy before?
      if (!(vehNum in vehicles)) {  // brand new guy!
        vehicles[vehNum] = {}; // create new hash
        vehicle = vehicles[vehNum];
        vehicle["type"] = vehType;
        // vehicles[vehNum]["latOff"] = Math.random() / 20000;
        // vehicles[vehNum]["lonOff"] = Math.random() / 20000;
        vehicle["marker"] = new google.maps.Marker({
          // vehicles[vehNum]["marker"] = new MarkerWithLabel({
          zIndex: 1000000-(10000*lat),  // globalZindex++,
        });
        // if they click the icon, pop up a window
        google.maps.event.addListener(vehicle["marker"], 'click', function () {
          //vehicle["marker"].setZIndex(globalZindex++);  // pop to top
          vehicle["infoWindow"] = new google.maps.InfoWindow();
          // populate with something
          //vehicle["infoWindow"].setContent(buildBusInfoWindowContent(vehNum,message.getDestination().getName()));
          vehicle["infoWindow"].setContent(vehicle["infoWindowContent"]);
          vehicle["infoWindow"].open(map, vehicle["marker"]);
          console.log(vehicle.infoWindowContent);
          google.maps.event.addListener(vehicle["infoWindow"], 'closeclick', function () {
            vehicle["infoWindow"] = null;
          });
        });
        // now, is it coming into our search area?
        if (totalSearchShapes > 0) {
          newOneEnteringShape = true;  // we'll do a special marker later on
          // console.log(">>> BUS ENTER: "+vehNum);
          var fenceMessage = solace.SolclientFactory.createMessage();
          //var topicName = "geo/fence/" + fenceUid + "/enter/" + vehNum + "/" + levels[5];  // geo/fence/abcd/enter/1037/003 (route num at end)
          var topicName = "geo/fence/" + fenceUid + "/enter/" + levels[3] + "/" + levels[4];  // geo/fence/abcd/enter/1037/003 (route num at end)
          fenceMessage.setDestination(solace.SolclientFactory.createTopic(topicName));
          var newPayload = JSON.parse(JSON.stringify(payload));
          newPayload['fenceStatus'] = "enter";
          newPayload['fenceUid'] = fenceUid;
          fenceMessage.setBinaryAttachment(JSON.stringify(newPayload));
          fenceMessage.setDeliveryMode(solace.MessageDeliveryModeType.DIRECT);
          try {
            mySession.send(fenceMessage);
          } catch (e) {
            console.error(e.toString());
          }
        }

      }
      // now we've inserted the new guy for sure
      vehicle = vehicles[vehNum];
      //lat = lat + vehicle["latOff"];
      //lon += vehicle["lonOff"];
      vehicle["pos"] = new google.maps.LatLng(lat, lon);
      vehicle["marker"].setPosition(vehicle["pos"]);
      vehicle["marker"].setAnimation(google.maps.Animation.NONE);
      vehicle["marker"].setZIndex(1000000-(10000*lat));  // globalZindex++,

      vehicle["payload"] = payload;
      if (vehType == "bus") {
        //vehicle["route"] = +levels[5];  // numeric representation
        setBusIcon(vehNum);
        if (newOneEnteringShape) {
          // vehicle["marker"].setIcon(map.getZoom() <= 12 ? icon_bus_small_msg : icon_bus_med_msg);
          //vehicle.marker.setIcon(icon_bus_white_arrow);
          if (curSubs > 1) vehicle["marker"].setAnimation(google.maps.Animation.DROP);
        }
      } else if (vehType == "taxi") {
        vehicle["marker"].setIcon(icon_dot);
      }
      // text = 51.502110,-0.092490|63 Darwin Street, London SE17 1EZ, UK|51.492200,-0.087780|63 Watling Street, London EC4M 9DD, UK|51.512870,-0.093050
      // remember! When sending from Java app, Need to encode the strings in Java with UTF-8 and write as byte attachments, don't use just text message! (uses WIn encoding on windows)
      // var levels2 = text.split("|");
      // label = levels2[0];
      // if (levels2.length > 1) {
      // startAddr = levels2[1];
      // startLat = levels2[2].split(",")[0];
      // startLon = levels2[2].split(",")[1];
      // endAddr = levels2[3];
      // endLat = levels2[4].split(",")[0];
      // endLon = levels2[4].split(",")[1];

      vehicle["marker"].setOpacity(1);
      if (vehicle["marker"].getMap() == null) {  // this is needed to prevent flickering, rather than just setting the map explicitly
        vehicle["marker"].setMap(map);
      }
      vehicle["ts"] = Date.now();
      vehicle["infoWindowContent"] = buildBusInfoWindowContent(vehNum, message.getDestination().getName());
      if (vehicle["infoWindow"] != null) {
        // update it
        vehicle["infoWindow"].setContent(vehicle["infoWindowContent"]);
      }
} catch (e) {
  console.error(e);
  // discard silently for now
}
    }  // end parseGeoMessage


    replyReceivedCb = function (session, message) {
      var text = message.getBinaryAttachment();
      //if (document.querySelector('#display').value == "Outline") {
      //    updateSubsBoundary(text);
      //  } else {
      updateSubs(text);
      //  }
    };

    replyFailedCb = function (session, event) {
      //console.log(event.infoStr);
      //console.log(event.toString());
      setWorking(false);
    };

    this.utils_updateContent = function (msg) {
      console.log("content: '" + msg + "'");
    };

    function myFunction() {
      var x = document.createElement("INPUT");
      x.setAttribute("type", "range");
      document.body.appendChild(x);
    }

    function logslider(position) {
      // position will be between 0 and 100
      var minp = 0;
      var maxp = 100;
      // The result should be between 4 and 2000
      var minv = Math.log(4);
      var maxv = Math.log(1500);
      // calculate adjustment factor
      var scale = (maxv - minv) / (maxp - minp);
      return Math.round(Math.exp(minv + scale * (position - minp)));
    }

    function revlogslider(position) {
      // position will be between 0 and 100
      var minp = 100; // reverse so it gets slower towards the top
      var maxp = 0;
      // The result should be between 10 and 99%
      var minv = Math.log(10);
      var maxv = Math.log(99);
      // calculate adjustment factor
      var scale = (maxv - minv) / (maxp - minp);
      return Math.round(109 - Math.exp(minv + scale * (position - minp))); // subtract from 109 to flip the range from 99-10 => 10-99
    }

    google.maps.event.addDomListener(window, 'load', onLogin);
  </script>
</head>

<body>
  <!--div id="aa"><h1>Aar<span class="orange_o">O</span>n's Geo Routing Demo <span class="small">v2.0&beta;</span></h1></div-->

  <div id="map-canvas"></div>
  <div id="over_map_filtering">
    <h1>Geo Filtering:</h1>
    <table>
      <!--tr>
        <td>
          <nobr><span class="newSliders">Show: </span>
          <select id="show" onchange="updateSearch()">
            <option value="all">All Vehicles</option>
            <option value="buses">Only Buses</option>
            <option value="taxi">Only Taxis</option>
          </select></nobr>
        </td>
      </tr-->
      <tr>
        <td>
          <table>
            <tr>
              <td align="left">
                <button id="addCircleButton" onclick="addNewCircle(); updateSearch()">Add <span style="color:#f71; font-weight: 900;">Circle</span></button>
              </td>
              <td align="right">
                <button id="addPolyButton" onclick="addNewPoly(); updateSearch();">Add <span style="color:#f71; font-weight: 900;">Polygon</span></button>
              </td>
            </tr>
            <tr>
              <td align="left">
                <button id="addRectButton" onclick="addNewRect(); updateSearch();">Add <span style="color:#f71; font-weight: 900;">Rect</span></button>
              </td>
              <td align="right">
                <button id="removeAllShapesButton"
                  onclick="clearAllShapes(); document.getElementById('curSubs').innerHTML = '1'; document.getElementById('curAccuracy').innerHTML = '<span style=\'font-size: 70%\'>N/A</span>';">Remove
                  <span style="color:#f71; font-weight: 900;">Shapes</span></button>
              </td>
            </tr>
          </table>
        </td>
      </tr>
      <!--tr>
        <td>
          <nobr><span class="newSliders">Display: </span>
          <select id="display" onchange="updateSearch()">
            <option value="Outline">Outline</option>
            <option value="Subscriptions">Subscriptions</option>
          </select></nobr>
        </td>
      </tr-->
      <tr>
        <td>
          <table>
            <!--tr>
              <td>
                <label for=fader2>Accuracy:</label>
              </td>
              <td>
                <input type=range min=0 max=100 value=71 id=fader2 oninput="outputAccuracyUpdate(value)" onchange="updateSearch()">
                <output for=fader2 id=accuracy class="newSliders">90</output><span class="newSliders">%</span>
                <script>
                  function outputAccuracyUpdate(val) {
                    document.querySelector('#accuracy').value = revlogslider(val);
                    accuracy = revlogslider(val) / 100.0;
                  }
                </script>
              </td>
            </tr-->
            <tr>
              <td>
                <label for=fader>Max Subs:</label>
              </td>
              <td style="padding: 2px 0px">
                <!--input type=range min=0 max=100 value=63 id=fader oninput="outputSubUpdate(value)" onchange="updateSearch()"-->
                <input class="slider" type=range min=0 max=100 value=73 id=fader oninput="outputSubUpdate(value)"
                  onchange="updateSearch()">
                <output for=fader id=subs class="newSliders">300</output>
                <script>
                  function outputSubUpdate(val) {
                    document.querySelector('#subs').value = logslider(val);
                    numSubs = logslider(val);
                  }
                </script>
              </td>
            </tr>
            <tr>
              <td>
                <label for=fader2>Accuracy:</label>
              </td>
              <td style="padding: 5px 0px">
                <input type="range" class="slider" min=0 max=100 value=71 id=fader2 oninput="outputAccuracyUpdate(value)"
                  onchange="updateSearch()">
                <output for=fader2 id=accuracy class="newSliders">90</output><span class="newSliders">%</span>
                <script>
                  function outputAccuracyUpdate(val) {
                    document.querySelector('#accuracy').value = revlogslider(val);
                    accuracy = revlogslider(val) / 100.0;
                  }
                </script>
              </td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <table>
            <tr>
              <td>Filter by <span style="color:#ff0; font-weight: 900;">Route</span> number:</td>
              <td><input type="text" id="routeNum" onchange="updateSearch()" size="4" /></td>
            </tr>
            <tr>
              <td>Filter by <span style="color:#f5f; font-weight: 900;">Vehicle</span> number:</td>
              <td><input type="text" id="vehNum" onchange="updateSearch()" size="4" /></td>
            </tr>
            <tr>
              <td>Filter by <span style="color:#0ff; font-weight: 900;">Heading:</span></td>
              <td>
                <select id="heading" class="decorated" onchange="updateSearch()">
                  <option value="*">&nbsp;&nbsp;Any&nbsp;&nbsp;</option>
                  <option value="0*">&nbsp;&nbsp;NE</option>
                  <option value="1*">&nbsp;&nbsp;SE</option>
                  <option value="2*">&nbsp;&nbsp;SW</option>
                  <option value="3*">&nbsp;&nbsp;NW</option>
                </select>
              </td>
            </tr>
            <tr>
              <td colspan="2">Filter by <span style="color:#fff; font-weight: 900;">Status:</span>&nbsp;&nbsp;
                <select id="status" class="decorated" onchange="updateSearch()">
                  <option value="any">&nbsp;Any</option>
                  <option value="OK">&nbsp;In Motion</option>
                  <option value="STOPPED">&nbsp;At Bus Stop</option>
                  <option value="FAULT">Broken Down</option>
                </select>
              </td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td>
          <!--button id="heatButton" onclick="heatmap.setMap(heatmap.getMap() ? null : map); if (heatmap.getMap() && zoomLevel < 13) map.setZoom(13);">Toggle Heatmap</button-->
          <button onclick='window.open("http://worldcomp-proceedings.com/proc/p2016/ICM3967.pdf", "_blank");'>See the Algo&nbsp;</button>
          <button onclick='window.open("https://github.com/aaron-613/pubsub-geo-filtering", "_blank");'>&nbsp;See the Code</button>
        </td>
      </tr>
    </table>

  </div>
  <div id="over_map_tr">
    <table>
      <tr>
        <td valign="top">
          <img src="solace-logo-2.png"/>
          <h1>Real-time Connected Buses Demo</h1>
          <p />
          <!--h3>Bidirectional IoT Communication using MQTT<br><a href="http://worldcomp-proceedings.com/proc/p2016/ICM3967.pdf" taret="_blank"><h3>Advanced Filtering and Routing Capabilities</h3></a></h3-->
          <h3>Bidirectional IoT Communication using MQTT<br>Advanced Filtering and Routing Capabilities</h3>
        </td>
      </tr>
    </table>
  </div>


  </div>
  <div id="over_map_busapp_qr">
    <table>
      <tr>
        <td style="text-align:right"><a href="https://sg.solace.com/busapp/" target="_blank"><img width="75" padding="0" margin="10" src="qr-busapp.png" /></a></td>
        <td style="padding-left:10px; padding-bottom:5px;">
          <a href="https://sg.solace.com/busapp/" target="_blank"><h2>Bus<br />Driver<br />App</h2></a>
        </td>
      </tr>
    </table>
  </div>

  <div id="over_map_bl">
    <table>
      <tr>
        <td>
          <h4>Recv'd Message Rate:</h4>
        </td>
        <td>
          <h4><b><span id='rate' name='rate'>0</span> msg/s</b></h4>
        </td>
      </tr>
      <tr>
        <td>
          <h4># of Subscriptions:</h4>
        </td>
        <td>
          <h4><span id='curSubs'>1</span></h4>
        </td>
      </tr>
      <tr>
        <td>
          <h4>Coverage Accuracy:</h4>
        </td>
        <td>
          <h4><span id='curAccuracy'><span style="font-size: 70%">N/A</span></span></h4>
        </td>
      </tr>
      <tr>
        <td>
          <h4>Tracked Buses:</h4>
        </td>
        <td>
          <h4><span id='totalBuses'>0</span></h4>
        </td>
      </tr>
    </table>
  </div>

  <div id="over_map_fence">
    <table>
      <tr>
        <td rowspan="1" style="padding-right: 5px;"><span id='fence-qr' name='fence-qr'>QR HERE</span></td>
        <td>
          <h2>GeoFence<br />Notifications</h2><a id='fence-target' href="blank" target="_blank">Open in new Tab</a>
        </td>
      </tr>
    </table>
  </div>

  <div id="real-time-topics">
    <table>
      <tr>
        <!--td style='font-family:  Monaco, "Lucida Console", monospace; font-weight: bold; font-size: 120%; color: #aaa; padding: 0px 0px 2px;'-->
        <td style='font-family:  Monaco, "Lucida Console", monospace; font-weight: bold; font-size: 150%; color: #aaa; padding: 0px 0px 2px;'>
        <!--       const levelColors = [ '#aaa', '#5f5', '#58f', '#ff0', '#f5f', '#f73', '#f73', '#0ff', '#fff', '#888' ]; -->
        <span style="color:#aaa">bus_trak</span
          >/<span style="color:#5f5;">gps</span
          >/<span style="color:#58f;">v2</span
          >/<span style="color:#ff0;">{route}</span
          >/<span style="color:#f5f;">{busID}</span
          >/<span style="color:#f71;">{lat}</span
          >/<span style="color:#f71;">{lon}</span
          >/<span style="color:#0ff;">{dir}</span
          >/<span style="color:#fff;">{status}</span>
        </td>
      </tr>
      <tr>
        <td style='font-family:  Monaco, "Lucida Console", monospace; font-weight: bold; font-size: 150%; color: #aaa; padding: 2px 0px;'>
          <span id="topic">&nbsp;</span>
        </td>
      </tr>
      <tr>
        <td style='font-family:  Monaco, "Lucida Console", monospace; font-weight: bold; font-size: 150%; color: #aaa; padding: 2px 0px 0px;'>
          <!--span id="sub"><span style="color:#fff">geo</span>/<span style="color:#5f5;">bus</span>/<span style="color: #fff;">&gt;</span></span-->
          <span id="sub">&nbsp;</span>
        </td>
      </tr>
    </table>
  </div>

  <div id="topicMO" style='font-family:  Monaco, "Lucida Console", monospace; font-weight: bold; font-size: 120%; color: #aaa;'>
    <p>abc/abc/123/456</p>
  </div>
  <script>
   document.getElementById("over_map_fence").style.display = "none";
   document.getElementById("topicMO").style.display = "none";
   </script>
</body>

</html>
